services:
  ipfs:
    image: ipfs/kubo:latest
    container_name: sleetbubble-ipfs-${NODE_ID:-node1}
    ports:
      - "${IPFS_SWARM_PORT:-4001}:4001"
      - "${IPFS_GATEWAY_PORT:-8080}:8080"
      - "${IPFS_API_PORT:-5001}:5001"
    volumes:
      - ./data/ipfs:/data/ipfs
      - ./ipfs.config.json:/ipfs-config/ipfs.config.json:ro
      - ./src/ipfs/init-ipfs.sh:/container-init.d/001-cors-config.sh:ro
    environment:
      - IPFS_PROFILE=server
    restart: unless-stopped

  setup:
    build:
      context: .
      dockerfile: src/setup/Dockerfile
    image: sleetbubble-setup:latest
    container_name: sleetbubble-setup-${NODE_ID:-node1}
    depends_on:
      - ipfs
    volumes:
      - .:/workspace
      - ./data/state:/state
      - ./data/processed:/data/processed
      - ./src:/src
      - ./keys/sleetbubble-sex.key:/workspace/keys/sleetbubble-sex.key:ro
    environment:
      - IPFS_API=http://ipfs:5001
      - STATE_DIR=/state
      - NODE_ID=${NODE_ID:-node1}
    restart: "no"

  streamer:
    build:
      context: .
      dockerfile: src/streamer/Dockerfile
      cache_from:
        - sleetbubble-streamer:latest
    image: sleetbubble-streamer:latest
    container_name: sleetbubble-streamer-${NODE_ID:-node1}
    depends_on:
      setup:
        condition: service_completed_successfully
      ipfs:
        condition: service_started
    volumes:
      - .:/workspace
      - ./data/state:/state
      - ./data/processed:/data/processed
      - ./src:/src
      - ./streaming.config.json:/workspace/streaming.config.json:ro
    environment:
      - IPFS_API=http://ipfs:5001
      - IPFS_GATEWAY=http://ipfs:8080
      - STATE_DIR=/state
      - PROCESSED_DIR=/data/processed
      - NODE_ID=${NODE_ID:-node1}
      - STREAMING_CONFIG=/workspace/streaming.config.json
    restart: unless-stopped

  # config-page:
  #   build:
  #     context: .
  #     dockerfile: src/config-page/Dockerfile
  #     cache_from:
  #       - sleetbubble-config-page:latest
  #   image: sleetbubble-config-page:latest
  #   container_name: sleetbubble-config-page-${NODE_ID:-node1}
  #   depends_on:
  #     setup:
  #       condition: service_completed_successfully
  #     ipfs:
  #       condition: service_started
  #     streamer:
  #       condition: service_started
  #   ports:
  #     - "${CONFIG_PAGE_PORT:-5500}:5500"
  #     - "${IPFS_CORS_PROXY_PORT:-8888}:8888"
  #   volumes:
  #     - ./src/config-page/index.html:/app/index.html:ro
  #     - ./data/state:/state:ro
  #     - ./data/music:/music:ro
  #   restart: unless-stopped


